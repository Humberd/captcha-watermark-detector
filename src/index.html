<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta
    name="viewport"
    content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0"
  >
  <meta
    http-equiv="X-UA-Compatible"
    content="ie=edge"
  >
  <link
    rel="stylesheet"
    href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css"
    integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh"
    crossorigin="anonymous"
  >
  <script src="index.js"></script>
  <style>
    #preview {
      display: flex;
      flex-wrap: wrap;
    }

    .layer {
      margin-right: 10px;
    }

    .layer .name {
      margin-top: 10px;
      margin-bottom: 2px;
    }

    button {

    }

    button.selected {
      background-color: lightblue;
    }
  </style>

  <title>Document</title>
</head>
<body>
<img
  style="display: none;"
  id="raw-image"
  src="cbimage.jpg"
>

<section id="buttons">

</section>

<article id="preview">
  <section class="layer">
    <h3 class="name">0. Raw</h3>
    <canvas
      id="canvas"
    ></canvas>
  </section>
</article>


<script>
  const images = [
    'captcha2.png',
    'cbimage.jpg',
  ];

  const buttonsElem = document.getElementById('buttons');

  const allButtons = images.map(image => {
    const buttonElem = document.createElement('button');
    buttonElem.onclick = ev => {
      allButtons.forEach(it => it.classList.remove('selected'));
      buttonElem.classList.add('selected');
    };
    buttonElem.textContent = image;

    return buttonElem;
  });

  buttonsElem.append(...allButtons);

</script>


<script>
  const IMG_WIDTH = 398;
  const IMG_HEIGHT = 200;
  const rawImage = document.getElementById('raw-image');

  const canvas = document.getElementById('canvas');
  canvas.width = IMG_WIDTH;
  canvas.height = IMG_HEIGHT;

  setTimeout(() => {
    const context = canvas.getContext('2d');
    context.drawImage(rawImage, 0, 0);
    const layers = filterImage(context.getImageData(0, 0, IMG_WIDTH, IMG_HEIGHT));
    layers.forEach(layer => addPreview(layer));

    const lastLayerPixels = layers[layers.length - 1].pixels;
    const watermarkXStartIndex = detectWatermarkXStartPosition(lastLayerPixels);

    const newCanvas = addPreview({
      name: 'Final: Detected',
      pixels: lastLayerPixels,
    });
    const ctx = newCanvas.getContext('2d');
    ctx.beginPath();
    ctx.strokeStyle = '#00ff00';
    ctx.moveTo(watermarkXStartIndex, 0);
    ctx.lineTo(watermarkXStartIndex, IMG_HEIGHT);
    ctx.stroke();
  });

  function addPreview(layer) {
    const newCanvas = document.createElement('canvas');
    newCanvas.width = IMG_WIDTH;
    newCanvas.height = IMG_HEIGHT;
    newCanvas.getContext('2d').putImageData(layer.pixels, 0, 0);

    const layerNameElem = document.createElement('h3');
    layerNameElem.classList.add('name');
    layerNameElem.textContent = layer.name;

    const newLayerElem = document.createElement('section');
    newLayerElem.classList.add('layer');
    newLayerElem.append(layerNameElem, newCanvas);

    document.getElementById('preview').append(newLayerElem);

    return newCanvas;
  }
</script>

</body>
</html>
