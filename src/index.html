<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta
    name="viewport"
    content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0"
  >
  <meta
    http-equiv="X-UA-Compatible"
    content="ie=edge"
  >
  <link
    rel="stylesheet"
    href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css"
    integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh"
    crossorigin="anonymous"
  >
  <script src="index.js"></script>
  <style>
    #preview {
      display: flex;
      flex-wrap: wrap;
    }

    .layer {
      margin-right: 10px;
    }

    .layer .name {
      margin-top: 10px;
      margin-bottom: 2px;
    }

    button.selected {
      background-color: lightblue;
    }
  </style>

  <title>Document</title>
</head>
<body>

<section id="buttons">

</section>

<article id="preview">
  <section class="layer">
    <h3 class="name">0. Raw</h3>
    <canvas
      id="canvas"
    ></canvas>
  </section>
</article>

<script>
  const IMG_WIDTH = 398;
  const IMG_HEIGHT = 200;

  function updatePreview(src) {
    const tempImgElem = document.createElement('img');
    tempImgElem.src = src;
    tempImgElem.onload = ev => afterImageLoaded(tempImgElem);
  }

  function afterImageLoaded(imgElem) {
    clearPreview();
    const baseCanvas = document.createElement('canvas');
    baseCanvas.width = IMG_WIDTH;
    baseCanvas.height = IMG_HEIGHT;
    const ctx = baseCanvas.getContext('2d');
    ctx.drawImage(imgElem, 0, 0);

    const baseImgPixels = ctx.getImageData(0, 0, IMG_WIDTH, IMG_HEIGHT);
    const layers = filterImage(baseImgPixels);
    layers.forEach(layer => addPreviewLayer(layer));

    const lastLayerPixels = layers[layers.length - 1].pixels;
    drawLastLayer(lastLayerPixels)
  }

  function drawLastLayer(pixels) {
    const watermarkXStartIndex = detectWatermarkXStartPosition(pixels);
    const newCanvas = addPreviewLayer({
      name: 'Final: Detected',
      pixels: pixels,
    });
    const newCanvasCtx = newCanvas.getContext('2d');
    newCanvasCtx.beginPath();
    newCanvasCtx.strokeStyle = '#00ff00';
    newCanvasCtx.moveTo(watermarkXStartIndex, 0);
    newCanvasCtx.lineTo(watermarkXStartIndex, IMG_HEIGHT);
    newCanvasCtx.stroke();
  }

  function addPreviewLayer(layer) {
    const newCanvas = document.createElement('canvas');
    newCanvas.width = IMG_WIDTH;
    newCanvas.height = IMG_HEIGHT;
    newCanvas.getContext('2d').putImageData(layer.pixels, 0, 0);

    const layerNameElem = document.createElement('h3');
    layerNameElem.classList.add('name');
    layerNameElem.textContent = layer.name;

    const newLayerElem = document.createElement('section');
    newLayerElem.classList.add('layer');
    newLayerElem.append(layerNameElem, newCanvas);

    document.getElementById('preview').append(newLayerElem);

    return newCanvas;
  }

  function clearPreview() {
    document.getElementById('preview').innerHTML = '';
  }
</script>

<script>
  const images = [
    'captcha2.png',
    'cbimage.jpg',
  ];

  const buttonsElem = document.getElementById('buttons');

  const allButtons = images.map(image => {
    const buttonElem = document.createElement('button');
    buttonElem.onclick = ev => {
      allButtons.forEach(it => it.classList.remove('selected'));
      buttonElem.classList.add('selected');

      updatePreview(buttonElem.textContent);
    };
    buttonElem.textContent = image;

    return buttonElem;
  });

  allButtons[0].click();
  buttonsElem.append(...allButtons);

</script>

</body>
</html>
